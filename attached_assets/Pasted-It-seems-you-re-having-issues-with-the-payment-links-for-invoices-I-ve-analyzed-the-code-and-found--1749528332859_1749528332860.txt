It seems you're having issues with the payment links for invoices. I've analyzed the code and found a few areas that could be causing problems. Here is a breakdown of the issues and how to resolve them.

1. Incorrect Payment Link Generation
The primary issue is how payment links are being generated in your payment.service.ts file. The code is creating a URL by embedding the Stripe Payment Intent's client_secret directly into the link .

The Problem:

A Payment Intent's client_secret is not a token for a URL. It's a secret key intended to be used on the frontend with the Stripe.js library to securely confirm a payment. Exposing it in a URL is a security risk and will not lead to a functional payment page.

The Solution:

Instead of manually creating a URL, you should use Stripe's Payment Links feature for shareable payment links or pass the client_secret to your frontend application to use with Stripe Elements. Your stripe.service.ts file already has a method for this, createPaymentLink , which is the correct approach for creating a shareable link.

Here's how you can correct the code in payment.service.ts:

TypeScript

// server/services/payment.service.ts

// ... imports

export class PaymentService {
  // ... other methods

  async processQuoteAcceptance(quoteId: number, customerInfo: { /* ... */ }) {
    try {
      // ... (get quote, create project)

      const downPaymentInvoice = await this.createDownPaymentInvoice(/* ... */);

      // CORRECT WAY: Create a Stripe Payment Link
      const paymentLink = await stripeService.createPaymentLink({
        amount: Math.round(paymentSchedule.downPayment.amount * 100),
        description: `Down payment for ${quote.title} - Quote #${quote.quoteNumber}`,
        invoiceId: downPaymentInvoice.id,
        successUrl: `${process.env.BASE_URL || 'http://localhost:5000'}/payment-success`,
      });

      // Update invoice with the actual payment link URL
      await storage.invoices.updateInvoice(downPaymentInvoice.id, {
        paymentLink: paymentLink.url, // Use the URL from the payment link
      });
      
      // ...
    } catch (error) {
      // ...
    }
  }

  // ... other methods like createMilestonePayment, createFinalPayment, sendDraftInvoice
  // should be updated to use stripeService.createPaymentLink in a similar fashion.
}
You'll need to apply this correction to all places where a payment link is generated, including createMilestonePayment and createFinalPayment .

2. Frontend Payment Handling
Your frontend PaymentForm component is correctly set up to handle a client_secret with Stripe Elements . This is great for payments that happen directly within your app.

If you switch to using Stripe Payment Links as suggested above, the user will be redirected to a Stripe-hosted page to complete payment. After payment, they will be redirected back to the successUrl you provide. Your backend will then be notified of the successful payment via a webhook.

3. Server-Side Routes and Controllers
Your routes in payment.routes.ts and invoice.routes.ts seem to be set up correctly to handle the creation and processing of payments and invoices. The main issue lies within the service layer as described above.

Once you correct the payment link generation in payment.service.ts, the rest of your backend infrastructure should work as expected.

I recommend you make these changes to ensure your payment links are secure and functional. Let me know if you have any other questions.