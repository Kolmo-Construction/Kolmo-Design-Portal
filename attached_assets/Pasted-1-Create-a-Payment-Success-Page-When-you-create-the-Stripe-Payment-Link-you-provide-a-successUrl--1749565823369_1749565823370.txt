1. Create a Payment Success Page
When you create the Stripe Payment Link, you provide a successUrl. In your code, this URL is /payment-success. After a customer successfully pays on the Stripe-hosted page, Stripe will redirect them back to this URL.

The Issue: Your frontend router in client/src/App.txt does not have a route defined for /payment-success. This will cause another 404 error after the payment is complete.

The Fix:
You need to add a new route and a corresponding component to handle this redirect.

a. Create a PaymentSuccessPage.tsx component:
This can be a simple page that confirms the payment and thanks the customer.

TypeScript

// src/pages/PaymentSuccessPage.tsx (New File)
import React from 'react';
import { Link } from 'wouter';
import { Button } from '@/components/ui/button';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { CheckCircle2 } from 'lucide-react';

export default function PaymentSuccessPage() {
  return (
    <div className="min-h-screen bg-gray-50 flex items-center justify-center">
      <Card className="w-full max-w-md mx-4 text-center">
        <CardHeader>
          <CheckCircle2 className="h-16 w-16 text-green-500 mx-auto mb-4" />
          <CardTitle className="text-2xl">Payment Successful!</CardTitle>
        </CardHeader>
        <CardContent>
          <p className="text-gray-600 mb-6">
            Thank you for your payment. Your project details have been updated. You will receive a confirmation email shortly.
          </p>
          <Button asChild>
            <Link href="/">Return to Dashboard</Link>
          </Button>
        </CardContent>
      </Card>
    </div>
  );
}
b. Add the route in client/src/App.txt:

TypeScript

// client/src/App.txt

// ... other imports
import PaymentSuccessPage from "@/pages/PaymentSuccessPage"; // Import the new component

function Router() {
  return (
    <Switch>
      // ... other routes
      <Route path="/quote-payment/:id" component={QuotePaymentPage} />
      <Route path="/payment-success" component={PaymentSuccessPage} /> // <-- ADD THIS ROUTE

      {/* Development-only routes */}
      // ...
    </Switch>
  );
}
// ...
2. Update Your Stripe Webhook Handler
This is the most critical part. Your current webhook handler is listening for the wrong event. Payments made via a Stripe Payment Link trigger a checkout.session.completed event, but your code is only listening for payment_intent.succeeded. This means your backend will never be notified of the successful payment, and your invoice status will not be updated.

The Fix:
You need to update your webhook handler in server/routes/webhook.routes.ts and your success handler in server/services/payment.service.ts.

a. Update server/routes/webhook.routes.ts to handle the correct event:

TypeScript

// server/routes/webhook.routes.ts
// ... (imports)

router.post('/stripe', async (req, res, next) => {
  try {
    const signature = req.headers['stripe-signature'] as string;
    // ... (signature check)
    const event = await stripeService.constructEvent(req.body, signature);
    console.log(`[Webhook] Received event: ${event.type}`);

    // Handle the event
    switch (event.type) {
      // --- THIS IS THE NEW, CORRECTED LOGIC ---
      case 'checkout.session.completed': {
        const session = event.data.object as Stripe.Checkout.Session;
        // Pass the entire session object to the success handler
        await paymentService.handlePaymentSuccess(session);
        console.log(`[Webhook] Successfully processed Checkout Session: ${session.id}`);
        break;
      }
      // --- END OF FIX ---

      // You can keep this for other payment flows if needed, but it won't be triggered by Payment Links
      case 'payment_intent.succeeded': {
        const paymentIntent = event.data.object as Stripe.PaymentIntent;
        // You might need to adapt handlePaymentSuccess or create a new method if you use both flows
        // For now, we focus on the checkout session.
        console.log(`[Webhook] Legacy payment intent succeeded: ${paymentIntent.id}`);
        break;
      }

      default:
        console.log(`[Webhook] Unhandled event type: ${event.type}`);
    }

    res.json({ received: true });
  } catch (error) {
    // ...
  }
});

// ...
b. Update server/services/payment.service.ts to use the webhook data correctly:

Your current handlePaymentSuccess function expects a paymentIntentId. You should modify it to accept the Stripe Checkout.Session object and extract the invoiceId from its metadata, which you correctly added when creating the payment link.

TypeScript

// server/services/payment.service.ts
import type { Stripe } from 'stripe'; // Import Stripe type for session object

// ... (inside PaymentService class)

  /**
   * Handle successful payment from webhook
   * @param session - The Stripe Checkout Session object from the webhook event
   */
  async handlePaymentSuccess(session: Stripe.Checkout.Session): Promise<void> {
    try {
      // The invoice ID was stored in the metadata when the link was created
      const invoiceId = session.metadata?.invoiceId ? parseInt(session.metadata.invoiceId, 10) : null;
      
      if (invoiceId) {
        const invoice = await storage.invoices.getInvoiceById(invoiceId);

        if (invoice && invoice.status !== 'paid') {
          // Update invoice status to paid
          await storage.invoices.updateInvoice(invoiceId, { status: 'paid' as const });

          // Record the payment
          const paymentAmount = (session.amount_total ?? 0) / 100; // Amount is in cents
          const paymentData = {
            invoiceId: invoiceId,
            amount: paymentAmount.toFixed(2),
            paymentDate: new Date(),
            paymentMethod: 'stripe',
            reference: session.id, // Use checkout session ID as reference
            stripePaymentIntentId: typeof session.payment_intent === 'string' ? session.payment_intent : undefined,
            status: 'succeeded',
          };
          await storage.invoices.recordPayment(paymentData);
          
          console.log(`Payment successful for invoice ${invoiceId}, amount: $${paymentAmount}`);
          
          // Send appropriate confirmation email
          if (invoice.invoiceType === 'down_payment' && invoice.projectId) {
            await this.sendProjectWelcomeEmail(invoice.projectId);
            console.log(`Project welcome email sent for project ${invoice.projectId}`);
          } else {
            await this.sendPaymentConfirmationEmail(invoice, paymentAmount);
            console.log(`Payment confirmation email sent for invoice ${invoice.invoiceNumber}`);
          }
        } else {
          console.log(`[Webhook] Invoice ${invoiceId} already marked as paid or not found. Skipping.`);
        }
      } else {
        console.error('[Webhook] Error: checkout.session.completed event received without an invoiceId in metadata.');
      }
    } catch (error) {
      console.error('Error handling payment success webhook:', error);
      throw error;
    }
  }
With these two fixes—the success page and the webhook handler—your payment link flow will be complete and robust.